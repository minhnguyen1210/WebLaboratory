<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vietnam Place - KhÃ¡m phÃ¡ Viá»‡t Nam</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="/style.css">
<link rel="icon" href="data:,">
<script src="/huggingface_client.js" defer></script>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ‡»ğŸ‡³ KhÃ¡m phÃ¡ Ä‘á»‹a Ä‘iá»ƒm Viá»‡t Nam</h1>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="auth-login-btn show" onclick="showAuthModal()">
                 ÄÄƒng nháº­p
            </button>
            <div class="user-menu" id="userMenu">
                <div class="user-avatar" onclick="toggleUserDropdown()">
                    <span id="userInitial">U</span>
                </div>
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-dropdown-item" style="font-weight: 600; cursor: default;">
                        <span></span>
                        <span id="userEmail">user@example.com</span>
                    </div>
                    <hr style="border: none; border-top: 1px solid var(--border); margin: 5px 0;">
                    <div class="user-dropdown-item" onclick="logout()">
                        <span></span>
                        <span>ÄÄƒng xuáº¥t</span>
                    </div>
                </div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="theme-icon">ğŸŒ™</span>
                <span id="theme-text">Tá»‘i</span>
            </button>
        </div>
    </header>

    <!-- Auth Modal -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <button class="auth-close" onclick="closeAuthModal()">Ã—</button>
            
            <div class="auth-header">
                <h2>ChÃ o má»«ng! </h2>
                <p style="color: var(--text-secondary);">ÄÄƒng nháº­p Ä‘á»ƒ lÆ°u Ä‘á»‹a Ä‘iá»ƒm yÃªu thÃ­ch</p>
            </div>

            <div id="authAlert"></div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchTab('login')">ÄÄƒng nháº­p</button>
                <button class="auth-tab" onclick="switchTab('register')">ÄÄƒng kÃ½</button>
            </div>

            <!-- Login Form -->
            <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label> Email</label>
                    <input type="email" name="email" placeholder="name@example.com" required>
                </div>
                <div class="form-group">
                    <label> Máº­t kháº©u</label>
                    <input type="password" name="password" placeholder="Nháº­p máº­t kháº©u" required>
                </div>
                <button type="submit" class="auth-btn" id="loginBtn">ÄÄƒng nháº­p</button>

                <div class="auth-link">
                    <a onclick="showResetPassword()">QuÃªn máº­t kháº©u?</a>
                </div>
            </form>

            <!-- Register Form -->
            <form class="auth-form" id="registerForm" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label> TÃªn hiá»ƒn thá»‹</label>
                    <input type="text" name="display_name" placeholder="Nguyá»…n VÄƒn A" required>
                </div>
                <div class="form-group">
                    <label> Email</label>
                    <input type="email" name="email" placeholder="name@example.com" required>
                </div>
                <div class="form-group">
                    <label> Máº­t kháº©u</label>
                    <input type="password" name="password" placeholder="Tá»‘i thiá»ƒu 6 kÃ½ tá»±" minlength="6" required>
                </div>
                <div class="form-group">
                    <label> XÃ¡c nháº­n máº­t kháº©u</label>
                    <input type="password" name="confirm_password" placeholder="Nháº­p láº¡i máº­t kháº©u" required>
                </div>
                <button type="submit" class="auth-btn" id="registerBtn">ÄÄƒng kÃ½</button>
            </form>
        </div>
    </div>

    <div class="search-box">
        <form method="post">
            <input type="text" name="location" placeholder="Nháº­p Ä‘á»‹a Ä‘iá»ƒm, vÃ­ dá»¥: ÄÃ  Náºµng, Há»™i An..." value="{{ query }}" required>
            <button type="submit">ğŸ” TÃ¬m kiáº¿m</button>
        </form>
    </div>

    <!-- AI Chatbot Box -->
    <div class="chatbot-box">
        <h3>ğŸ¤– Chatbot AI - Trá»£ lÃ½ du lá»‹ch thÃ´ng minh</h3>
        <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 14px;">
            ğŸ’¬ Há»i tÃ´i báº¥t cá»© Ä‘iá»u gÃ¬ vá» du lá»‹ch Viá»‡t Nam! TÃ´i cÃ³ thá»ƒ giÃºp báº¡n tÃ¬m Ä‘á»‹a Ä‘iá»ƒm, gá»£i Ã½ lá»‹ch trÃ¬nh, giá»›i thiá»‡u mÃ³n Äƒn, vÃ  nhiá»u hÆ¡n ná»¯a.
        </p>

        <div class="chatbot-form">
            <!-- Messages Display -->
            <div class="chatbot-messages" id="chatbotMessages" style="
                background: var(--card-bg);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 15px;
                min-height: 350px;
                max-height: 500px;
                overflow-y: auto;
                margin-bottom: 15px;
                display: flex;
                flex-direction: column;
                gap: 12px;
            ">
                <div class="chat-welcome" style="
                    color: var(--text-secondary); 
                    text-align: center; 
                    padding: 40px 20px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    gap: 15px;
                ">
                    <div style="font-size: 48px;">ğŸ¤–</div>
                    <div style="font-size: 16px; font-weight: 500;">Xin chÃ o! TÃ´i lÃ  trá»£ lÃ½ AI du lá»‹ch</div>
                    <div style="font-size: 14px; opacity: 0.8;">Há»i tÃ´i vá»:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; max-width: 400px;">
                        <span class="suggestion-chip" onclick="sendSuggestion('Gá»£i Ã½ Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch á»Ÿ ÄÃ  Náºµng')">
                            ğŸ–ï¸ Äá»‹a Ä‘iá»ƒm du lá»‹ch
                        </span>
                        <span class="suggestion-chip" onclick="sendSuggestion('MÃ³n Äƒn ná»•i tiáº¿ng á»Ÿ HÃ  Ná»™i')">
                            ğŸœ MÃ³n Äƒn Ä‘áº·c sáº£n
                        </span>
                        <span class="suggestion-chip" onclick="sendSuggestion('Thá»i tiáº¿t á»Ÿ Sapa thÃ¡ng 12')">
                            â˜€ï¸ Thá»i tiáº¿t
                        </span>
                        <span class="suggestion-chip" onclick="sendSuggestion('LÃªn lá»‹ch trÃ¬nh 3 ngÃ y á»Ÿ Há»™i An')">
                            ğŸ“… Lá»‹ch trÃ¬nh du lá»‹ch
                        </span>
                    </div>
                </div>
            </div>

            <!-- Question Input -->
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input 
                    type="text" 
                    id="chatbotQuestion" 
                    placeholder="Nháº­p cÃ¢u há»i cá»§a báº¡n... (VD: Gá»£i Ã½ Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch á»Ÿ PhÃº Quá»‘c)" 
                    style="
                        flex: 1; 
                        padding: 14px; 
                        border: 2px solid var(--border); 
                        border-radius: 8px; 
                        color: var(--text); 
                        background: var(--card-bg); 
                        font-family: inherit;
                        font-size: 14px;
                        transition: border-color 0.2s;
                    "
                    onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); askChatbotAI(); }"
                    onfocus="this.style.borderColor='var(--primary)'"
                    onblur="this.style.borderColor='var(--border)'"
                >
                <button onclick="askChatbotAI()" style="
                    padding: 14px 24px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 600;
                    font-size: 14px;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                " 
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'" 
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.3)'">
                    <span>ğŸ“¤</span>
                    <span>Gá»­i</span>
                </button>
                <button onclick="clearChatbotAI()" style="
                    padding: 14px 20px;
                    background: var(--border);
                    color: var(--text);
                    border: none;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 500;
                    font-size: 14px;
                    transition: all 0.2s;
                " 
                onmouseover="this.style.background='var(--text-secondary)'; this.style.color='white'" 
                onmouseout="this.style.background='var(--border)'; this.style.color='var(--text)'">
                    ğŸ—‘ï¸
                </button>
            </div>

            <!-- Status bar -->
            <div id="chatbotStatus" style="
                font-size: 12px;
                color: var(--text-secondary);
                padding: 8px;
                text-align: center;
                border-radius: 5px;
                display: none;
            "></div>
        </div>
    </div>

    <!-- Translation Box -->
    <div class="translate-box">
        <h3>ğŸŒ Dá»‹ch vÄƒn báº£n</h3>
        <div class="translate-form">
            <div class="translate-input-group">
                <label for="translateInput">Nháº­p vÄƒn báº£n cáº§n dá»‹ch:</label>
                <textarea id="translateInput" placeholder="Nháº­p vÄƒn báº£n báº±ng ngÃ´n ngá»¯ khÃ¡c..." rows="4"></textarea>
            </div>
            
            <div class="translate-controls">
                <div class="lang-selector">
                    <div>
                        <label for="sourceLang">Tá»«:</label>
                        <select id="sourceLang">
                            <option value="auto">ğŸŒ Tá»± phÃ¡t hiá»‡n</option>
                            <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                            <option value="en">ğŸ‡¬ğŸ‡§ Tiáº¿ng Anh</option>
                            <option value="zh-CN">ğŸ‡¨ğŸ‡³ Tiáº¿ng Trung</option>
                            <option value="ja">ğŸ‡¯ğŸ‡µ Tiáº¿ng Nháº­t</option>
                            <option value="ko">ğŸ‡°ğŸ‡· Tiáº¿ng HÃ n</option>
                        </select>
                    </div>
        
                    <span class="arrow">â†’</span>
        
                    <div>
                        <label for="targetLang">Sang:</label>
                        <select id="targetLang">
                            <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                            <option value="en">ğŸ‡¬ğŸ‡§ Tiáº¿ng Anh</option>
                            <option value="zh-CN">ğŸ‡¨ğŸ‡³ Tiáº¿ng Trung</option>
                            <option value="ja">ğŸ‡¯ğŸ‡µ Tiáº¿ng Nháº­t</option>
                            <option value="ko">ğŸ‡°ğŸ‡· Tiáº¿ng HÃ n</option>
                        </select>
                    </div>
                </div>

                <button id="translateBtn" onclick="translateText()">Dá»‹ch</button>
            </div>
            <div class="translate-output" id="translateOutput" style="display: none;">
                <label>Káº¿t quáº£ dá»‹ch:</label>
                <div class="translated-result" id="translatedResult"></div>
            </div>
        </div>
    </div>

    {% if weather %}
    <div class="weather-box">
        <img class="weather-icon" src="https://openweathermap.org/img/wn/{{ weather.icon }}@2x.png" alt="">
        <div class="weather-info">
            <h3>â˜€ï¸ Thá»i tiáº¿t {{ display_name.split(',')[0] }}</h3>
            <div class="weather-details">
                <div class="weather-item"><span class="temp-main">{{ weather.temp }}Â°C</span></div>
                <div class="weather-item">ğŸ’§ Äá»™ áº©m: {{ weather.humidity }}%</div>
                <div class="weather-item">ğŸ’¨ GiÃ³: {{ weather.wind_speed }} m/s</div>
                <div class="weather-item">ğŸŒ¤ {{ weather.description | capitalize }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="route-info" id="routeInfo">
        <div class="route-stat">
            <span>ğŸš—</span>
            <div><div class="route-stat-value" id="routeDistance">--</div><div class="route-stat-label">Khoáº£ng cÃ¡ch</div></div>
        </div>
        <div class="route-stat">
            <span>â±ï¸</span>
            <div><div class="route-stat-value" id="routeDuration">--</div><div class="route-stat-label">Thá»i gian</div></div>
        </div>
        <button class="btn-clear" onclick="clearRoute()">âœ• XÃ³a tuyáº¿n Ä‘Æ°á»ng</button>
    </div>

    {% if lat and lon %}
    <div id="map"></div>
    {% endif %}

    {% if pois %}
    <div class="poi-list">
        <h2>ğŸ“ Äiá»ƒm du lá»‹ch gáº§n Ä‘Ã¢y ({{ pois|length }})</h2>
        <div class="poi-grid">
            {% for poi in pois %}
            <div class="poi-card" onclick="showRoute({{ lat }}, {{ lon }}, {{ poi.lat }}, {{ poi.lon }}, '{{ poi.name }}')">
                <h4>{{ poi.name }}</h4>
                <span class="poi-type">ğŸ·ï¸ {{ poi.type or 'Du lá»‹ch' }}</span>
                {% if poi.weather %}
                <div class="poi-weather">
                    <img src="https://openweathermap.org/img/wn/{{ poi.weather.icon }}.png" alt="">
                    <span><b>{{ poi.weather.temp }}Â°C</b></span>
                    <span>ğŸ’§ {{ poi.weather.humidity }}%</span>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<style>
.suggestion-chip {
    display: inline-block;
    padding: 8px 16px;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}

.suggestion-chip:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
    transform: translateY(-2px);
}

.chat-message {
    padding: 12px 16px;
    border-radius: 12px;
    max-width: 80%;
    word-wrap: break-word;
    line-height: 1.6;
    animation: slideIn 0.3s ease;
}

.chat-message.user {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.chat-message.assistant {
    background: var(--card-bg);
    color: var(--text);
    align-self: flex-start;
    border-bottom-left-radius: 4px;
    border: 1px solid var(--border);
}

.chat-message.error {
    background: #fee;
    color: #c33;
    border-left: 4px solid #c33;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes bounce {
    0%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-8px); }
}

.chatbot-messages::-webkit-scrollbar {
    width: 8px;
}

.chatbot-messages::-webkit-scrollbar-track {
    background: var(--bg);
    border-radius: 4px;
}

.chatbot-messages::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 4px;
}

.chatbot-messages::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}
</style>

<script>
// ============ AUTH STATE MANAGEMENT ============
let currentUser = null;

function checkAuthState() {
    const userData = localStorage.getItem('vietnamPlaceUser');
    if (userData) {
        try {
            currentUser = JSON.parse(userData);
            updateUIForUser(currentUser);
        } catch (e) {
            localStorage.removeItem('vietnamPlaceUser');
            updateUIForGuest();
        }
    } else {
        updateUIForGuest();
    }
}

function saveUserToStorage(user) {
    localStorage.setItem('vietnamPlaceUser', JSON.stringify(user));
    currentUser = user;
}

function removeUserFromStorage() {
    localStorage.removeItem('vietnamPlaceUser');
    currentUser = null;
}

function updateUIForUser(user) {
    document.querySelector('.auth-login-btn').classList.remove('show');
    document.getElementById('userMenu').classList.add('active');
    document.getElementById('userEmail').textContent = user.email;
    document.getElementById('userInitial').textContent = user.email[0].toUpperCase();
}

function updateUIForGuest() {
    document.querySelector('.auth-login-btn').classList.add('show');
    document.getElementById('userMenu').classList.remove('active');
}

checkAuthState();

function showAuthModal() {
    document.getElementById('authOverlay').classList.add('active');
}

function closeAuthModal() {
    document.getElementById('authOverlay').classList.remove('active');
    clearAuthAlert();
}

function switchTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    
    if (tab === 'login') {
        document.querySelectorAll('.auth-tab')[0].classList.add('active');
        document.getElementById('loginForm').classList.add('active');
    } else {
        document.querySelectorAll('.auth-tab')[1].classList.add('active');
        document.getElementById('registerForm').classList.add('active');
    }
    clearAuthAlert();
}

function showAuthAlert(message, type = 'success') {
    const alertDiv = document.getElementById('authAlert');
    alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
}

function clearAuthAlert() {
    document.getElementById('authAlert').innerHTML = '';
}

async function handleRegister(e) {
    e.preventDefault();
    const btn = document.getElementById('registerBtn');
    const form = e.target;
    
    const displayName = form.display_name.value;
    const email = form.email.value;
    const password = form.password.value;
    const confirmPassword = form.confirm_password.value;
    
    if (password !== confirmPassword) {
        showAuthAlert('Máº­t kháº©u xÃ¡c nháº­n khÃ´ng khá»›p!', 'error');
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'â³ Äang Ä‘Äƒng kÃ½...';
    
    try {
        const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                email: email,
                password: password,
                display_name: displayName
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAuthAlert('âœ… ' + data.message, 'success');
            setTimeout(() => {
                switchTab('login');
                form.reset();
            }, 3000);
        } else {
            showAuthAlert('âŒ ' + data.error, 'error');
        }
    } catch (error) {
        showAuthAlert('âŒ Lá»—i káº¿t ná»‘i!', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ÄÄƒng kÃ½';
    }
}

async function handleLogin(e) {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    const form = e.target;
    
    const email = form.email.value;
    const password = form.password.value;
    
    btn.disabled = true;
    btn.textContent = 'â³ Äang Ä‘Äƒng nháº­p...';
    
    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                email: email,
                password: password
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            saveUserToStorage(data.user);
            updateUIForUser(data.user);
            showAuthAlert('âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng!', 'success');
            
            setTimeout(() => {
                closeAuthModal();
                form.reset();
            }, 1500);
        } else {
            showAuthAlert('âŒ ' + data.error, 'error');
        }
    } catch (error) {
        showAuthAlert('âŒ Lá»—i káº¿t ná»‘i!', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ÄÄƒng nháº­p';
    }
}

async function logout() {
    try {
        await fetch('/api/auth/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        removeUserFromStorage();
        updateUIForGuest();
        toggleUserDropdown();
        alert('ÄÃ£ Ä‘Äƒng xuáº¥t thÃ nh cÃ´ng!');
    } catch (error) {
        alert('Lá»—i khi Ä‘Äƒng xuáº¥t!');
    }
}

function toggleUserDropdown() {
    document.getElementById('userDropdown').classList.toggle('active');
}

async function showResetPassword() {
    const email = prompt('Nháº­p email cá»§a báº¡n Ä‘á»ƒ Ä‘áº·t láº¡i máº­t kháº©u:');
    if (email) {
        try {
            const response = await fetch('/api/auth/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email })
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('âœ… ' + data.message);
            } else {
                alert('âŒ ' + data.error);
            }
        } catch (error) {
            alert('âŒ Lá»—i káº¿t ná»‘i!');
        }
    }
}

document.addEventListener('click', (e) => {
    if (!e.target.closest('.user-menu')) {
        document.getElementById('userDropdown').classList.remove('active');
    }
});

// ============ THEME ============
const html = document.documentElement;
const savedTheme = localStorage.getItem('theme') || 'light';
html.setAttribute('data-theme', savedTheme);
updateThemeUI();

function toggleTheme() {
    const current = html.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    updateThemeUI();
    if (typeof updateMapTiles === 'function') {
        updateMapTiles();
    }
}

function updateThemeUI() {
    const isDark = html.getAttribute('data-theme') === 'dark';
    document.getElementById('theme-icon').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
    document.getElementById('theme-text').textContent = isDark ? 'SÃ¡ng' : 'Tá»‘i';
}

// ============ TRANSLATION ============
async function translateText() {
    const inputText = document.getElementById('translateInput').value.trim();
    const targetLang = document.getElementById('targetLang').value;
    const btn = document.getElementById('translateBtn');
    const output = document.getElementById('translateOutput');
    const result = document.getElementById('translatedResult');
    
    if (!inputText) {
        alert('Vui lÃ²ng nháº­p vÄƒn báº£n cáº§n dá»‹ch!');
        return;
    }
    
    btn.disabled = true;
    btn.textContent = 'â³ Äang dá»‹ch...';
    output.style.display = 'block';
    result.textContent = 'Äang xá»­ lÃ½...';
    
    try {
        const res = await fetch('/api/translate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                text: inputText, 
                target: targetLang  
            })
        });
        
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        
        result.textContent = data.translated;
        btn.textContent = 'âœ” ÄÃ£ dá»‹ch';
        
        setTimeout(() => {
            btn.disabled = false;
            btn.textContent = 'Dá»‹ch';
        }, 2000);
    } catch (e) {
        result.textContent = 'âŒ Lá»—i: KhÃ´ng thá»ƒ dá»‹ch. Vui lÃ²ng thá»­ láº¡i.';
        btn.disabled = false;
        btn.textContent = 'Dá»‹ch';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('translateInput');
    if (textarea) {
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                translateText();
            }
        });
    }
});

// ============ CHATBOT AI FUNCTIONS ============

function sendSuggestion(text) {
    document.getElementById('chatbotQuestion').value = text;
    askChatbotAI();
}

// ============ CHATBOT AI FUNCTIONS - CONTINUATION ============

async function askChatbotAI() {
    const question = document.getElementById('chatbotQuestion').value.trim();

    if (!question) {
        showChatbotStatus('âš ï¸ Vui lÃ²ng nháº­p cÃ¢u há»i!', 'warning');
        return;
    }

    const welcome = document.querySelector('.chat-welcome');
    if (welcome) {
        welcome.remove();
    }

    addChatMessageNew(question, 'user');
    showChatLoadingNew();
    document.getElementById('chatbotQuestion').value = '';

    try {
        const response = await hfClient.chat(question);

        removeChatLoadingNew();

        if (response.success) {
            addChatMessageNew(response.response, 'assistant');
        } else {
            if (response.error === 'MODEL_LOADING') {
                addChatMessageNew('â³ ' + response.response + '\n\nMáº¹o: Model AI Ä‘ang khá»Ÿi Ä‘á»™ng láº§n Ä‘áº§u. HÃ£y thá»­ láº¡i sau 20-30 giÃ¢y.', 'assistant');
            } else {
                addChatMessageNew('âŒ ' + response.response, 'error');
            }
        }
    } catch (error) {
        removeChatLoadingNew();
        addChatMessageNew(`âŒ Lá»—i: ${error.message}`, 'error');
    }

    document.getElementById('chatbotQuestion').focus();
}

function addChatMessageNew(text, type = 'user') {
    const messagesDiv = document.getElementById('chatbotMessages');

    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}`;
    
    const formattedText = text.replace(/\n/g, '<br>');
    messageDiv.innerHTML = formattedText;

    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function showChatLoadingNew() {
    const messagesDiv = document.getElementById('chatbotMessages');

    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'chatLoadingNew';
    loadingDiv.className = 'chat-message assistant';
    loadingDiv.style.padding = '16px';

    loadingDiv.innerHTML = `
        <div style="display: flex; gap: 6px; align-items: center;">
            <span style="width: 10px; height: 10px; background: var(--primary); border-radius: 50%; animation: bounce 1.4s infinite;"></span>
            <span style="width: 10px; height: 10px; background: var(--primary); border-radius: 50%; animation: bounce 1.4s infinite; animation-delay: 0.2s;"></span>
            <span style="width: 10px; height: 10px; background: var(--primary); border-radius: 50%; animation: bounce 1.4s infinite; animation-delay: 0.4s;"></span>
            <span style="margin-left: 8px; font-size: 13px; color: var(--text-secondary);">AI Ä‘ang suy nghÄ©...</span>
        </div>
    `;

    messagesDiv.appendChild(loadingDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function removeChatLoadingNew() {
    const loadingDiv = document.getElementById('chatLoadingNew');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

function clearChatbotAI() {
    if (typeof hfClient !== 'undefined') {
        hfClient.clearHistory();
    }
    
    document.getElementById('chatbotQuestion').value = '';
    document.getElementById('chatbotMessages').innerHTML = `
        <div class="chat-welcome" style="
            color: var(--text-secondary); 
            text-align: center; 
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        ">
            <div style="font-size: 48px;">ğŸ¤–</div>
            <div style="font-size: 16px; font-weight: 500;">Xin chÃ o! TÃ´i lÃ  trá»£ lÃ½ AI du lá»‹ch</div>
            <div style="font-size: 14px; opacity: 0.8;">Há»i tÃ´i vá»:</div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; max-width: 400px;">
                <span class="suggestion-chip" onclick="sendSuggestion('Gá»£i Ã½ Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch á»Ÿ ÄÃ  Náºµng')">
                    ğŸ–ï¸ Äá»‹a Ä‘iá»ƒm du lá»‹ch
                </span>
                <span class="suggestion-chip" onclick="sendSuggestion('MÃ³n Äƒn ná»•i tiáº¿ng á»Ÿ HÃ  Ná»™i')">
                    ğŸœ MÃ³n Äƒn Ä‘áº·c sáº£n
                </span>
                <span class="suggestion-chip" onclick="sendSuggestion('Thá»i tiáº¿t á»Ÿ Sapa thÃ¡ng 12')">
                    â˜€ï¸ Thá»i tiáº¿t
                </span>
                <span class="suggestion-chip" onclick="sendSuggestion('LÃªn lá»‹ch trÃ¬nh 3 ngÃ y á»Ÿ Há»™i An')">
                    ğŸ“… Lá»‹ch trÃ¬nh du lá»‹ch
                </span>
            </div>
        </div>
    `;
    
    showChatbotStatus('âœ… ÄÃ£ xÃ³a lá»‹ch sá»­ há»™i thoáº¡i', 'success');
    setTimeout(() => hideChatbotStatus(), 2000);
}

function showChatbotStatus(message, type = 'info') {
    const statusDiv = document.getElementById('chatbotStatus');
    statusDiv.textContent = message;
    statusDiv.style.display = 'block';
    
    if (type === 'success') {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
    } else if (type === 'warning') {
        statusDiv.style.background = '#fff3cd';
        statusDiv.style.color = '#856404';
    } else if (type === 'error') {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
    } else {
        statusDiv.style.background = 'var(--card-bg)';
        statusDiv.style.color = 'var(--text-secondary)';
    }
}

function hideChatbotStatus() {
    document.getElementById('chatbotStatus').style.display = 'none';
}

function sendSuggestion(text) {
    document.getElementById('chatbotQuestion').value = text;
    askChatbotAI();
}

// Check API status on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (typeof hfClient !== 'undefined') {
            if (hfClient.isOnline) {
                showChatbotStatus('âœ… Chatbot AI Ä‘Ã£ sáºµn sÃ ng', 'success');
            } else {
                showChatbotStatus('âš ï¸ Cáº§n khá»Ÿi Ä‘á»™ng backend: python huggingface_api.py', 'warning');
            }
            setTimeout(() => hideChatbotStatus(), 4000);
        }
    }, 1000);
});
</script>

<!-- MAP JAVASCRIPT -->
{% if lat and lon %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const lightTile = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
const darkTile = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';

const map = L.map('map').setView([{{ lat }}, {{ lon }}], 14);
let tileLayer = L.tileLayer(savedTheme === 'dark' ? darkTile : lightTile, {
    attribution: 'Â© OpenStreetMap'
}).addTo(map);

function updateMapTiles() {
    const isDark = html.getAttribute('data-theme') === 'dark';
    map.removeLayer(tileLayer);
    tileLayer = L.tileLayer(isDark ? darkTile : lightTile, { 
        attribution: 'Â© OpenStreetMap' 
    }).addTo(map);
}

const redIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41], 
    iconAnchor: [12, 41], 
    popupAnchor: [1, -34], 
    shadowSize: [41, 41]
});

const blueIcon = L.icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    iconSize: [25, 41], 
    iconAnchor: [12, 41], 
    popupAnchor: [1, -34], 
    shadowSize: [41, 41]
});

const centerLat = {{ lat }}, centerLon = {{ lon }};
{% if weather %}
const centerPopup = `<div class="popup-content">
    <h4>ğŸ“ {{ display_name.split(',')[0] }}</h4>
    <hr>
    <div class="popup-weather">
        <img src="https://openweathermap.org/img/wn/{{ weather.icon }}.png">
        <div><b>{{ weather.temp }}Â°C</b><br><small>{{ weather.description }}</small></div>
    </div>
    <div style="margin-top:8px;font-size:12px">ğŸ’§ {{ weather.humidity }}% | ğŸ’¨ {{ weather.wind_speed }} m/s</div>
</div>`;
{% else %}
const centerPopup = `<div class="popup-content"><h4>ğŸ“ {{ display_name }}</h4></div>`;
{% endif %}
L.marker([centerLat, centerLon], {icon: redIcon}).addTo(map).bindPopup(centerPopup).openPopup();

const pois = {{ pois|tojson }};
pois.forEach(poi => {
    let popup = `<div class="popup-content">
        <h4>${poi.name}</h4>
        <small>ğŸ·ï¸ ${poi.type || 'Du lá»‹ch'}</small>`;
    
    if (poi.weather) {
        popup += `<hr><div class="popup-weather">
            <img src="https://openweathermap.org/img/wn/${poi.weather.icon}.png">
            <div><b>${poi.weather.temp}Â°C</b><br><small>${poi.weather.description}</small></div>
        </div>
        <div style="margin-top:8px;font-size:12px">ğŸ’§ ${poi.weather.humidity}% | ğŸ’¨ ${poi.weather.wind_speed} m/s</div>`;
    }
    
    popup += `<button class="popup-btn" onclick="showRoute(${centerLat},${centerLon},${poi.lat},${poi.lon},'${poi.name.replace(/'/g, "\\'")}')">
        ğŸš— Chá»‰ Ä‘Æ°á»ng
    </button></div>`;
    
    L.marker([poi.lat, poi.lon], {icon: blueIcon}).addTo(map).bindPopup(popup);
});

let routeLine = null;

async function showRoute(lat1, lon1, lat2, lon2, destName) {
    clearRoute();
    try {
        const res = await fetch(`/api/route?lat1=${lat1}&lon1=${lon1}&lat2=${lat2}&lon2=${lon2}`);
        const data = await res.json();
        
        if (data.error) { 
            alert('KhÃ´ng tÃ¬m tháº¥y tuyáº¿n Ä‘Æ°á»ng'); 
            return; 
        }
        
        routeLine = L.polyline(data.coordinates, {
            color: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim() || '#667eea',
            weight: 5, 
            opacity: 0.8
        }).addTo(map);
        
        map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
        
        document.getElementById('routeDistance').textContent = data.distance_km + ' km';
        document.getElementById('routeDuration').textContent = Math.round(data.duration_min) + ' phÃºt';
        document.getElementById('routeInfo').classList.add('active');
        displayRouteSteps(data.steps);
    } catch (e) { 
        alert('Lá»—i khi tÃ¬m tuyáº¿n Ä‘Æ°á»ng'); 
    }
}

function displayRouteSteps(steps) {
    let stepsHTML = '<div class="route-steps"><h4>ğŸ“ Chá»‰ Ä‘Æ°á»ng chi tiáº¿t:</h4><ol>';
    
    steps.forEach((step, index) => {
        const distanceText = step.distance >= 1000 
            ? `${(step.distance / 1000).toFixed(1)} km` 
            : `${step.distance} m`;
        
        stepsHTML += `
            <li>
                <div class="step-instruction">${step.instruction}</div>
                <div class="step-details">
                    <span class="step-name">${step.name}</span>
                    <span class="step-distance">${distanceText}</span>
                </div>
            </li>
        `;
    });
    
    stepsHTML += '</ol></div>';

    const existingSteps = document.querySelector('.route-steps');
    if (existingSteps) {
        existingSteps.remove();
    }
    
    document.getElementById('routeInfo').insertAdjacentHTML('beforeend', stepsHTML);
}

function clearRoute() {
    if (routeLine) { 
        map.removeLayer(routeLine); 
        routeLine = null; 
    }
    document.getElementById('routeInfo').classList.remove('active');
    
    const existingSteps = document.querySelector('.route-steps');
    if (existingSteps) {
        existingSteps.remove();
    }
}
</script>
{% endif %}
</body>
</html>